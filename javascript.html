<script>
  let fixedCosts = [];
  let fixedTotal = 0;

  // ページ読み込み完了時の処理
  document.addEventListener('DOMContentLoaded', () => {
    initialize();
    document.getElementById('expense-form').addEventListener('submit', handleSaveData);
    document.getElementById('add-genre-form').addEventListener('submit', handleAddGenre);
    document.getElementById('month-select').addEventListener('change', handleMonthChange);
  });

  // 初期化関数
  function initialize() {
    showLoading(true);
    const today = new Date();
    document.getElementById('date').value = today.toISOString().slice(0, 10);
    
    google.script.run.withSuccessHandler(setupMonthSelector).getSheetNames();
    google.script.run.withSuccessHandler(setupGenreList).getGenres();
    google.script.run.withSuccessHandler(setupFixedCosts).getFixedCosts();
  }
  
  // 月選択プルダウンのセットアップ
  function setupMonthSelector(sheetNames) {
    const select = document.getElementById('month-select');
    const currentMonth = new Date().toISOString().slice(0, 7);
    if (!sheetNames.includes(currentMonth)) {
        sheetNames.unshift(currentMonth);
    }
    sheetNames.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    });
    loadDataForMonth(select.value);
  }

  // ジャンルリストのセットアップ
  function setupGenreList(genres) {
    const datalist = document.getElementById('genre-list');
    datalist.innerHTML = '';
    genres.forEach(genre => {
      const option = document.createElement('option');
      option.value = genre;
      datalist.appendChild(option);
    });
  }
  
  // 固定費のセットアップ
  function setupFixedCosts(costs) {
    fixedCosts = costs;
    fixedTotal = costs.reduce((sum, row) => sum + (Number(row[1]) || 0), 0);
    document.getElementById('fixed-total').textContent = fixedTotal.toLocaleString();
    updateGrandTotal();
  }

  // データ保存処理
  function handleSaveData(e) {
    e.preventDefault();

    // ▼ここからバリデーションチェックを追加▼
    const placeValue = document.getElementById('place').value.trim();
    const itemValue = document.getElementById('item').value.trim();

    if (!placeValue && !itemValue) {
      showMessage('「場所」と「品名」のどちらか一方は入力してください。', 'error');
      return; // 処理を中断
    }
    // ▲ここまで追加▲

    showLoading();
    const data = {
      month: document.getElementById('month-select').value,
      date: document.getElementById('date').value,
      place: placeValue,
      item: itemValue,
      amount: document.getElementById('amount').value,
      genre: document.getElementById('genre').value,
    };

    google.script.run.withSuccessHandler(response => {
      showMessage(response.message, response.status);
      if (response.status === 'success') {
        e.target.reset();
        document.getElementById('date').value = new Date().toISOString().slice(0, 10);
        loadDataForMonth(data.month);
      } else {
        hideLoading();
      }
    }).withFailureHandler(err => {
        showMessage(err.message, 'error');
        hideLoading();
    }).saveData(data);
  }
  
  // ジャンル追加処理
  function handleAddGenre(e) {
      e.preventDefault();
      showLoading();
      const newGenreInput = document.getElementById('new-genre');
      const newGenre = newGenreInput.value.trim();
      if (!newGenre) {
        showMessage('ジャンル名を入力してください。', 'error');
        hideLoading();
        return;
      }
      google.script.run.withSuccessHandler(response => {
          showMessage(response.message, response.status);
          if (response.status === 'success') {
              const datalist = document.getElementById('genre-list');
              const option = document.createElement('option');
              option.value = response.newGenre;
              datalist.appendChild(option);
              newGenreInput.value = '';
          }
          hideLoading();
      }).withFailureHandler(err => {
          showMessage(err.message, 'error');
          hideLoading();
      }).addGenre(newGenre);
  }

  // 月変更処理
  function handleMonthChange(e) {
    loadDataForMonth(e.target.value);
  }

  // 指定月のデータを読み込み
  function loadDataForMonth(month) {
    showLoading(true);
    google.script.run.withSuccessHandler(updateUIWithData).withFailureHandler(err => {
        showMessage(err.message, 'error');
        hideLoading();
    }).loadData(month);
  }

  // データでUIを更新
  function updateUIWithData(data) {
    const tbody = document.getElementById('expense-table-body');
    tbody.innerHTML = '';
    let variableTotal = 0;
    const genreTotals = {};

    data.sort((a, b) => new Date(a[1]) - new Date(b[1]));

    data.forEach(row => {
      const tr = document.createElement('tr');
      const date = new Date(row[1]);
      const formattedDate = `${date.getMonth()+1}/${date.getDate()}`;
      // ▼ここから一覧表示の行を修正▼
      tr.innerHTML = `
        <td>${formattedDate}</td>
        <td>${escapeHTML(row[2])}</td>
        <td>${escapeHTML(row[3])}</td>
        <td>${Number(row[4]).toLocaleString()} 円</td>
        <td>${escapeHTML(row[5])}</td>
      `;
      // ▲ここまで修正▲
      tbody.appendChild(tr);

      const amount = Number(row[4]) || 0;
      const genre = row[5] || '未分類';
      variableTotal += amount;
      genreTotals[genre] = (genreTotals[genre] || 0) + amount;
    });

    document.getElementById('variable-total').textContent = variableTotal.toLocaleString();
    
    const genreSummaryDiv = document.getElementById('genre-summary');
    genreSummaryDiv.innerHTML = '<h3>ジャンル別合計</h3>';
    
    const chartContainer = document.createElement('div');
    chartContainer.className = 'chart-container';

    const sortedGenres = Object.entries(genreTotals).sort((a, b) => b[1] - a[1]);
    const maxTotal = sortedGenres.length > 0 ? sortedGenres[0][1] : 0;

    if (maxTotal > 0) {
        sortedGenres.forEach(([genre, total]) => {
            const percentage = (total / maxTotal) * 100;
            const row = document.createElement('div');
            row.className = 'chart-bar-row';
            const labelDiv = document.createElement('div');
            labelDiv.className = 'chart-label';
            labelDiv.innerHTML = `<span>${escapeHTML(genre)}</span><strong>${total.toLocaleString()} 円</strong>`;
            const barBg = document.createElement('div');
            barBg.className = 'chart-bar-bg';
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            
            barBg.appendChild(bar);
            row.appendChild(labelDiv);
            row.appendChild(barBg);
            chartContainer.appendChild(row);
            
            setTimeout(() => { bar.style.width = percentage + '%'; }, 100);
        });
    } else {
      chartContainer.textContent = '今月の支出データはまだありません。';
    }
    genreSummaryDiv.appendChild(chartContainer);
    
    updateGrandTotal();
    hideLoading();
  }

  // 総合計を更新
  function updateGrandTotal() {
    const variableTotal = Number(document.getElementById('variable-total').textContent.replace(/,/g, '')) || 0;
    const grandTotal = variableTotal + fixedTotal;
    document.getElementById('grand-total').textContent = grandTotal.toLocaleString();
  }
  
  function showMessage(msg, type) {
      const area = document.getElementById('message-area');
      area.textContent = msg;
      area.className = type === 'success' ? 'message-success' : 'message-error';
      setTimeout(() => { area.className = ''; area.style.display = 'none'; }, 4000);
  }
  
  function escapeHTML(str) {
      return str.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
  }

  // ローディング表示（簡易版）
  function showLoading(isInitial = false) {
      document.body.style.cursor = 'wait';
      if(isInitial) document.getElementById('expense-table-body').innerHTML = '<tr><td colspan="5" style="text-align:center;">読み込み中...</td></tr>';
  }
  function hideLoading() {
      document.body.style.cursor = 'default';
  }
</script>
